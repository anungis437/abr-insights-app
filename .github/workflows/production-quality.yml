name: Production Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  ban-console-calls:
    name: Block console.* in Runtime Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Block console.log in runtime code
        run: |
          echo "üîç Checking for console.log in runtime code..."
          
          # Exclude allowed locations: logger implementations, development utilities
          CONSOLE_LOGS=$(git ls-files | \
            grep -E '\.(ts|tsx|js|jsx)$' | \
            grep -v 'lib/utils/logger.ts' | \
            grep -v 'lib/utils/production-logger.ts' | \
            grep -v 'lib/observability/logger.ts' | \
            grep -v '.test.' | \
            grep -v '.spec.' | \
            grep -v 'vitest' | \
            xargs grep -n 'console\.log(' 2>/dev/null || true)
          
          if [ -n "$CONSOLE_LOGS" ]; then
            echo ""
            echo "‚ùå FAIL: console.log found in runtime code:"
            echo "$CONSOLE_LOGS"
            echo ""
            echo "Use structured logging instead:"
            echo "  import { logger } from '@/lib/utils/production-logger'"
            echo "  logger.info('message', { context })"
            exit 1
          fi
          
          echo "‚úÖ PASS: No console.log in runtime code"
      
      - name: Block console.error without logger
        run: |
          echo "üîç Checking for raw console.error in runtime code..."
          
          # Find console.error not in logger implementations
          CONSOLE_ERRORS=$(git ls-files | \
            grep -E '\.(ts|tsx|js|jsx)$' | \
            grep -v 'lib/utils/logger.ts' | \
            grep -v 'lib/utils/production-logger.ts' | \
            grep -v 'lib/observability/logger.ts' | \
            grep -v '.test.' | \
            grep -v '.spec.' | \
            xargs grep -n 'console\.error(' 2>/dev/null || true)
          
          if [ -n "$CONSOLE_ERRORS" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARN: console.error found in runtime code:"
            echo "$CONSOLE_ERRORS"
            echo ""
            echo "Consider using structured logging:"
            echo "  logger.error('message', { error, context })"
            # Don't fail - warn only for now
          else
            echo "‚úÖ PASS: No raw console.error in runtime code"
          fi
      
      - name: Block console.warn without logger
        run: |
          echo "üîç Checking for raw console.warn in runtime code..."
          
          CONSOLE_WARNS=$(git ls-files | \
            grep -E '\.(ts|tsx|js|jsx)$' | \
            grep -v 'lib/utils/logger.ts' | \
            grep -v 'lib/utils/production-logger.ts' | \
            grep -v 'lib/observability/logger.ts' | \
            grep -v '.test.' | \
            xargs grep -n 'console\.warn(' 2>/dev/null || true)
          
          if [ -n "$CONSOLE_WARNS" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARN: console.warn found in runtime code:"
            echo "$CONSOLE_WARNS"
            echo ""
            echo "Consider using structured logging:"
            echo "  logger.warn('message', { context })"
            # Don't fail - warn only for now
          else
            echo "‚úÖ PASS: No raw console.warn in runtime code"
          fi
      
      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "Production Code Quality Checks Complete"
          echo "========================================"
          echo ""
          echo "Use structured logging for production code:"
          echo "  import { logger } from '@/lib/utils/production-logger'"
          echo "  logger.info('User logged in', { userId })"
          echo "  logger.error('Payment failed', { error, orderId })"
          echo ""
