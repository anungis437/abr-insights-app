name: Repository Hygiene

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  hygiene-checks:
    name: Repository Hygiene Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better secret detection

      - name: Block backup files
        run: |
          echo "üîç Checking for backup files that should never be committed..."

          BACKUP_FILES=$(git ls-files | grep -E '\.(bak|old|backup|tmp)$' || true)

          if [ -n "$BACKUP_FILES" ]; then
            echo ""
            echo "‚ùå FAIL: Backup files detected in repository:"
            echo "$BACKUP_FILES"
            echo ""
            echo "These files should be in .gitignore and never committed."
            echo "Run: git rm <file> to remove them."
            exit 1
          fi

          echo "‚úÖ PASS: No backup files found"

      - name: Block Supabase temp artifacts
        run: |
          echo "üîç Checking for Supabase CLI temporary files..."

          TEMP_FILES=$(git ls-files | grep -E 'supabase/\.temp|supabase/\.branches' || true)

          if [ -n "$TEMP_FILES" ]; then
            echo ""
            echo "‚ùå FAIL: Supabase temporary files detected:"
            echo "$TEMP_FILES"
            echo ""
            echo "These are CLI artifacts and should not be committed."
            exit 1
          fi

          echo "‚úÖ PASS: No Supabase temp files found"

      - name: Block editor swap files
        run: |
          echo "üîç Checking for editor swap files..."

          SWAP_FILES=$(git ls-files | grep -E '\.(swp|swo|swn)|~$' || true)

          if [ -n "$SWAP_FILES" ]; then
            echo ""
            echo "‚ùå FAIL: Editor swap files detected:"
            echo "$SWAP_FILES"
            echo ""
            echo "These are temporary editor files and should not be committed."
            exit 1
          fi

          echo "‚úÖ PASS: No swap files found"

      - name: Block log files
        run: |
          echo "üîç Checking for log files..."

          LOG_FILES=$(git ls-files | grep -E '\.log$' | grep -v 'docs/' || true)

          if [ -n "$LOG_FILES" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARN: Log files detected (non-doc locations):"
            echo "$LOG_FILES"
            echo ""
            echo "Log files should typically not be committed unless they're test fixtures."
            # Don't fail, just warn
          else
            echo "‚úÖ PASS: No unexpected log files"
          fi

      - name: Check for large files
        run: |
          echo "üîç Checking for unexpectedly large files (>1MB)..."

          LARGE_FILES=$(git ls-files | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$SIZE" -gt 1048576 ]; then
                echo "$file ($SIZE bytes)"
              fi
            fi
          done)

          if [ -n "$LARGE_FILES" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARN: Large files detected (>1MB):"
            echo "$LARGE_FILES"
            echo ""
            echo "Consider if these should be stored elsewhere (S3, LFS, etc.)"
            # Don't fail, just warn for now
          else
            echo "‚úÖ PASS: No unexpectedly large files"
          fi

      - name: Verify .gitignore is comprehensive
        run: |
          echo "üîç Verifying .gitignore coverage..."

          REQUIRED_PATTERNS=(
            "*.backup"
            "*.old"
            "*.bak"
            "*.tmp"
            "node_modules"
            ".env"
            ".env.local"
          )

          MISSING_PATTERNS=()

          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              MISSING_PATTERNS+=("$pattern")
            fi
          done

          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå FAIL: .gitignore missing required patterns:"
            for pattern in "${MISSING_PATTERNS[@]}"; do
              echo "  - $pattern"
            done
            exit 1
          fi

          echo "‚úÖ PASS: .gitignore has all required patterns"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "========================================" 
          echo "‚úÖ ALL HYGIENE CHECKS PASSED"
          echo "========================================"
          echo ""
          echo "Repository is clean:"
          echo "- No backup files"
          echo "- No temp artifacts"
          echo "- No swap files"
          echo "- .gitignore is comprehensive"
          echo ""

  secret-scanning:
    name: Secret Detection (Gitleaks)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  dependency-security:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run npm audit
        run: |
          echo "üîç Scanning dependencies for vulnerabilities..."

          # Run audit and capture output
          if npm audit --audit-level=high; then
            echo "‚úÖ PASS: No high or critical vulnerabilities"
          else
            echo ""
            echo "‚ùå FAIL: High or critical vulnerabilities detected"
            echo ""
            echo "Run 'npm audit' locally to see details."
            echo "Run 'npm audit fix' to attempt automatic fixes."
            echo ""
            exit 1
          fi

      - name: Check for outdated dependencies
        run: |
          echo "üîç Checking for outdated dependencies..."
          npm outdated || true
          echo ""
          echo "‚ÑπÔ∏è  Run 'npm outdated' locally for details"
          echo "‚ÑπÔ∏è  Run 'npm update' to update dependencies"

  build-validation:
    name: Build & Type Check
    runs-on: ubuntu-latest

    env:
      # Dummy values for build (actual secrets not needed for type checking)
      NEXT_PUBLIC_SUPABASE_URL: 'https://example.supabase.co'
      NEXT_PUBLIC_SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9'
      SUPABASE_SERVICE_ROLE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: |
          echo "üîç Running TypeScript type check..."
          npm run type-check
          echo "‚úÖ PASS: Type check successful"

      - name: Lint check
        run: |
          echo "üîç Running ESLint..."
          npm run lint
          echo "‚úÖ PASS: Lint check successful"

      - name: Build check
        run: |
          echo "üîç Running production build..."
          npm run build
          echo "‚úÖ PASS: Build successful"
