name: Health Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  health-endpoints:
    name: Validate Health Endpoints
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check health endpoint files exist
        run: |
          echo "Checking for health endpoint files..."
          
          if [ ! -f "app/api/healthz/route.ts" ]; then
            echo "❌ /api/healthz endpoint missing"
            exit 1
          fi
          echo "✅ /api/healthz endpoint exists"
          
          if [ ! -f "app/api/readyz/route.ts" ]; then
            echo "❌ /api/readyz endpoint missing"
            exit 1
          fi
          echo "✅ /api/readyz endpoint exists"
          
          if [ ! -f "lib/utils/env-validator.ts" ]; then
            echo "❌ Environment validator missing"
            exit 1
          fi
          echo "✅ Environment validator exists"

      - name: Validate health endpoint contracts
        run: |
          echo "Validating health endpoint contracts..."
          
          # Check /api/healthz contract
          if ! grep -q "export const dynamic = 'force-dynamic'" app/api/healthz/route.ts; then
            echo "❌ /api/healthz must have dynamic = 'force-dynamic'"
            exit 1
          fi
          
          if ! grep -q "export async function GET" app/api/healthz/route.ts; then
            echo "❌ /api/healthz must export GET function"
            exit 1
          fi
          
          if ! grep -q '"status": "ok"' app/api/healthz/route.ts; then
            echo "❌ /api/healthz must return status: ok"
            exit 1
          fi
          
          echo "✅ /api/healthz contract valid"
          
          # Check /api/readyz contract
          if ! grep -q "export const dynamic = 'force-dynamic'" app/api/readyz/route.ts; then
            echo "❌ /api/readyz must have dynamic = 'force-dynamic'"
            exit 1
          fi
          
          if ! grep -q "export async function GET" app/api/readyz/route.ts; then
            echo "❌ /api/readyz must export GET function"
            exit 1
          fi
          
          if ! grep -q "status.*ready" app/api/readyz/route.ts; then
            echo "❌ /api/readyz must check readiness status"
            exit 1
          fi
          
          if ! grep -q "checkDatabase" app/api/readyz/route.ts; then
            echo "❌ /api/readyz must include database check"
            exit 1
          fi
          
          if ! grep -q "checkEnvironment" app/api/readyz/route.ts; then
            echo "❌ /api/readyz must include environment check"
            exit 1
          fi
          
          echo "✅ /api/readyz contract valid"

      - name: Validate environment validator
        run: |
          echo "Validating environment validator..."
          
          if ! grep -q "NEXT_PUBLIC_SUPABASE_URL" lib/utils/env-validator.ts; then
            echo "❌ Environment validator must check NEXT_PUBLIC_SUPABASE_URL"
            exit 1
          fi
          
          if ! grep -q "SUPABASE_SERVICE_ROLE_KEY" lib/utils/env-validator.ts; then
            echo "❌ Environment validator must check SUPABASE_SERVICE_ROLE_KEY"
            exit 1
          fi
          
          if ! grep -q "NEXTAUTH_SECRET" lib/utils/env-validator.ts; then
            echo "❌ Environment validator must check NEXTAUTH_SECRET"
            exit 1
          fi
          
          if ! grep -q "validateEnvironment" lib/utils/env-validator.ts; then
            echo "❌ Environment validator must export validateEnvironment function"
            exit 1
          fi
          
          echo "✅ Environment validator valid"

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://example.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'mock-anon-key-for-build-only' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-service-role-key-for-build-only' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'mock-secret-key-at-least-32-characters-long-for-testing' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}

      - name: Start application
        run: npm start &
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://example.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'mock-anon-key-for-build-only' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-service-role-key-for-build-only' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'mock-secret-key-at-least-32-characters-long-for-testing' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
          PORT: 3000

      - name: Wait for application startup
        run: |
          echo "Waiting for application to be ready..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:3000/api/healthz > /dev/null 2>&1; then
              echo "✅ Application started successfully"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting..."
            sleep 2
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "❌ Application failed to start within timeout"
            exit 1
          fi

      - name: Test /api/healthz endpoint
        run: |
          echo "Testing /api/healthz endpoint..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/healthz)
          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)
          
          echo "Response Status: $STATUS"
          echo "Response Body: $BODY"
          
          # Must return 200
          if [ "$STATUS" != "200" ]; then
            echo "❌ Expected status 200, got $STATUS"
            exit 1
          fi
          
          # Must include required fields
          if ! echo "$BODY" | grep -q '"status"'; then
            echo "❌ Response must include 'status' field"
            exit 1
          fi
          
          if ! echo "$BODY" | grep -q '"timestamp"'; then
            echo "❌ Response must include 'timestamp' field"
            exit 1
          fi
          
          if ! echo "$BODY" | grep -q '"uptime"'; then
            echo "❌ Response must include 'uptime' field"
            exit 1
          fi
          
          echo "✅ /api/healthz endpoint working correctly"

      - name: Test /api/readyz endpoint
        run: |
          echo "Testing /api/readyz endpoint..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/readyz)
          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)
          
          echo "Response Status: $STATUS"
          echo "Response Body: $BODY"
          
          # Must return 200 or 503 (depending on dependencies)
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "503" ]; then
            echo "❌ Expected status 200 or 503, got $STATUS"
            exit 1
          fi
          
          # Must include required fields
          if ! echo "$BODY" | grep -q '"status"'; then
            echo "❌ Response must include 'status' field"
            exit 1
          fi
          
          if ! echo "$BODY" | grep -q '"checks"'; then
            echo "❌ Response must include 'checks' field"
            exit 1
          fi
          
          if ! echo "$BODY" | grep -q '"environment"'; then
            echo "❌ Response must include 'environment' field"
            exit 1
          fi
          
          # Must perform environment check
          if ! echo "$BODY" | grep -q '"environment".*"status"'; then
            echo "❌ Must include environment check in 'checks' array"
            exit 1
          fi
          
          echo "✅ /api/readyz endpoint working correctly"

      - name: Test health endpoint performance
        run: |
          echo "Testing health endpoint performance..."
          
          # /api/healthz should respond < 100ms
          START=$(date +%s%3N)
          curl -sf http://localhost:3000/api/healthz > /dev/null
          END=$(date +%s%3N)
          HEALTHZ_TIME=$((END - START))
          
          echo "/api/healthz response time: ${HEALTHZ_TIME}ms"
          
          if [ $HEALTHZ_TIME -gt 100 ]; then
            echo "⚠️  /api/healthz took ${HEALTHZ_TIME}ms (target: < 100ms)"
          else
            echo "✅ /api/healthz performance acceptable"
          fi
          
          # /api/readyz should respond < 2000ms (includes DB check)
          START=$(date +%s%3N)
          curl -sf http://localhost:3000/api/readyz > /dev/null || true
          END=$(date +%s%3N)
          READYZ_TIME=$((END - START))
          
          echo "/api/readyz response time: ${READYZ_TIME}ms"
          
          if [ $READYZ_TIME -gt 2000 ]; then
            echo "⚠️  /api/readyz took ${READYZ_TIME}ms (target: < 2000ms)"
          else
            echo "✅ /api/readyz performance acceptable"
          fi

      - name: Validate no console.log in health endpoints
        run: |
          echo "Checking for console.log in health endpoints..."
          
          # Check both health endpoints
          if grep -r "console\.log" app/api/healthz/ app/api/readyz/ lib/utils/env-validator.ts 2>/dev/null; then
            echo "❌ Health endpoints must not use console.log"
            exit 1
          fi
          
          echo "✅ No console.log found in health endpoints"

  summary:
    name: Health Checks Summary
    runs-on: ubuntu-latest
    needs: [health-endpoints]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Health Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.health-endpoints.result }}" == "success" ]; then
            echo "✅ All health checks passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- /api/healthz endpoint working" >> $GITHUB_STEP_SUMMARY
            echo "- /api/readyz endpoint working" >> $GITHUB_STEP_SUMMARY
            echo "- Environment validation working" >> $GITHUB_STEP_SUMMARY
            echo "- Performance targets met" >> $GITHUB_STEP_SUMMARY
            echo "- Contract requirements satisfied" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Health checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
