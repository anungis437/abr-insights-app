name: AI Cost Controls

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate-schema:
    name: Validate AI Usage Schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check migration file exists
        run: |
          echo "Checking AI usage migration..."

          if [ ! -f "supabase/migrations/20260203_ai_usage_tracking.sql" ]; then
            echo "❌ AI usage migration missing"
            exit 1
          fi
          echo "✅ AI usage migration exists"

      - name: Validate schema tables
        run: |
          echo "Validating schema tables..."

          # Check ai_usage_daily table
          if ! grep -q "CREATE TABLE.*ai_usage_daily" supabase/migrations/20260203_ai_usage_tracking.sql; then
            echo "❌ ai_usage_daily table not defined"
            exit 1
          fi
          echo "✅ ai_usage_daily table defined"

          # Check ai_quota table
          if ! grep -q "CREATE TABLE.*ai_quota" supabase/migrations/20260203_ai_usage_tracking.sql; then
            echo "❌ ai_quota table not defined"
            exit 1
          fi
          echo "✅ ai_quota table defined"

      - name: Validate required columns
        run: |
          echo "Validating required columns..."

          MIGRATION_FILE="supabase/migrations/20260203_ai_usage_tracking.sql"

          # ai_usage_daily columns
          REQUIRED_USAGE_COLUMNS=(
            "organization_id"
            "date"
            "gpt4_requests"
            "gpt35_requests"
            "claude_requests"
            "embedding_requests"
            "total_cost_cents"
          )

          for col in "${REQUIRED_USAGE_COLUMNS[@]}"; do
            if ! grep -q "$col" "$MIGRATION_FILE"; then
              echo "❌ Missing column: $col in ai_usage_daily"
              exit 1
            fi
          done
          echo "✅ ai_usage_daily has required columns"

          # ai_quota columns
          REQUIRED_QUOTA_COLUMNS=(
            "organization_id"
            "daily_gpt4_limit"
            "daily_gpt35_limit"
            "monthly_cost_limit_cents"
            "enforce_limits"
          )

          for col in "${REQUIRED_QUOTA_COLUMNS[@]}"; do
            if ! grep -q "$col" "$MIGRATION_FILE"; then
              echo "❌ Missing column: $col in ai_quota"
              exit 1
            fi
          done
          echo "✅ ai_quota has required columns"

      - name: Validate database functions
        run: |
          echo "Validating database functions..."

          MIGRATION_FILE="supabase/migrations/20260203_ai_usage_tracking.sql"

          # Check get_monthly_ai_usage function
          if ! grep -q "CREATE.*FUNCTION get_monthly_ai_usage" "$MIGRATION_FILE"; then
            echo "❌ get_monthly_ai_usage function not defined"
            exit 1
          fi
          echo "✅ get_monthly_ai_usage function defined"

          # Check check_ai_quota function
          if ! grep -q "CREATE.*FUNCTION check_ai_quota" "$MIGRATION_FILE"; then
            echo "❌ check_ai_quota function not defined"
            exit 1
          fi
          echo "✅ check_ai_quota function defined"

      - name: Validate RLS policies
        run: |
          echo "Validating RLS policies..."

          MIGRATION_FILE="supabase/migrations/20260203_ai_usage_tracking.sql"

          # Check RLS enabled
          if ! grep -q "ENABLE ROW LEVEL SECURITY" "$MIGRATION_FILE"; then
            echo "❌ RLS not enabled on tables"
            exit 1
          fi
          echo "✅ RLS enabled"

          # Check policies exist
          if ! grep -q "CREATE POLICY" "$MIGRATION_FILE"; then
            echo "❌ No RLS policies defined"
            exit 1
          fi
          echo "✅ RLS policies defined"

  validate-service:
    name: Validate AI Quota Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check service file exists
        run: |
          echo "Checking AI quota service..."

          if [ ! -f "lib/services/ai-quota.ts" ]; then
            echo "❌ AI quota service missing"
            exit 1
          fi
          echo "✅ AI quota service exists"

      - name: Validate service exports
        run: |
          echo "Validating service exports..."

          SERVICE_FILE="lib/services/ai-quota.ts"

          # Check required functions
          REQUIRED_FUNCTIONS=(
            "checkQuota"
            "recordUsage"
            "getUsage"
            "getQuotaConfig"
            "calculateCost"
          )

          for func in "${REQUIRED_FUNCTIONS[@]}"; do
            if ! grep -q "$func" "$SERVICE_FILE"; then
              echo "❌ Missing function: $func"
              exit 1
            fi
          done
          echo "✅ All required functions present"

          # Check aiQuota export
          if ! grep -q "export const aiQuota" "$SERVICE_FILE"; then
            echo "❌ aiQuota not exported"
            exit 1
          fi
          echo "✅ aiQuota service exported"

      - name: Validate cost calculation
        run: |
          echo "Validating cost calculation..."

          SERVICE_FILE="lib/services/ai-quota.ts"

          # Check cost constants defined
          if ! grep -q "COST_PER_1K_TOKENS" "$SERVICE_FILE"; then
            echo "❌ Cost constants not defined"
            exit 1
          fi

          # Check all models have pricing
          MODELS=("gpt-4" "gpt-3.5-turbo" "claude" "embedding")
          for model in "${MODELS[@]}"; do
            if ! grep -q "'$model'" "$SERVICE_FILE"; then
              echo "❌ Missing pricing for model: $model"
              exit 1
            fi
          done
          echo "✅ Cost calculation configured for all models"

      - name: Validate structured logging
        run: |
          echo "Validating structured logging..."

          SERVICE_FILE="lib/services/ai-quota.ts"

          # Check logger import
          if ! grep -q "import.*logger.*from.*production-logger" "$SERVICE_FILE"; then
            echo "❌ Production logger not imported"
            exit 1
          fi

          # Check no console.log
          if grep -q "console\.log" "$SERVICE_FILE"; then
            echo "❌ Service uses console.log (must use structured logging)"
            exit 1
          fi

          echo "✅ Structured logging used"

  validate-api-endpoints:
    name: Validate API Endpoints
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check admin endpoint exists
        run: |
          echo "Checking admin API endpoint..."

          if [ ! -f "app/api/admin/ai-quota/route.ts" ]; then
            echo "❌ Admin AI quota endpoint missing"
            exit 1
          fi
          echo "✅ Admin AI quota endpoint exists"

      - name: Check user endpoint exists
        run: |
          echo "Checking user API endpoint..."

          if [ ! -f "app/api/ai-usage/route.ts" ]; then
            echo "❌ User AI usage endpoint missing"
            exit 1
          fi
          echo "✅ User AI usage endpoint exists"

      - name: Validate endpoint contracts
        run: |
          echo "Validating endpoint contracts..."

          ADMIN_FILE="app/api/admin/ai-quota/route.ts"
          USER_FILE="app/api/ai-usage/route.ts"

          # Admin endpoint must have GET and PUT
          if ! grep -q "export async function GET" "$ADMIN_FILE"; then
            echo "❌ Admin endpoint missing GET handler"
            exit 1
          fi

          if ! grep -q "export async function PUT" "$ADMIN_FILE"; then
            echo "❌ Admin endpoint missing PUT handler"
            exit 1
          fi
          echo "✅ Admin endpoint has GET and PUT handlers"

          # User endpoint must have GET
          if ! grep -q "export async function GET" "$USER_FILE"; then
            echo "❌ User endpoint missing GET handler"
            exit 1
          fi
          echo "✅ User endpoint has GET handler"

      - name: Validate authentication checks
        run: |
          echo "Validating authentication..."

          ADMIN_FILE="app/api/admin/ai-quota/route.ts"
          USER_FILE="app/api/ai-usage/route.ts"

          # Admin endpoint must check super_admin role
          if ! grep -q "super_admin" "$ADMIN_FILE"; then
            echo "❌ Admin endpoint doesn't check super_admin role"
            exit 1
          fi
          echo "✅ Admin endpoint checks super_admin"

          # User endpoint must authenticate
          if ! grep -q "getUser" "$USER_FILE"; then
            echo "❌ User endpoint doesn't authenticate"
            exit 1
          fi
          echo "✅ User endpoint authenticates"

      - name: Validate error codes
        run: |
          echo "Validating stable error codes..."

          ADMIN_FILE="app/api/admin/ai-quota/route.ts"
          USER_FILE="app/api/ai-usage/route.ts"

          # Check for stable error codes
          ERROR_CODES=(
            "FORBIDDEN"
            "UNAUTHORIZED"
            "MISSING_PARAMETER"
            "INTERNAL_ERROR"
          )

          for code in "${ERROR_CODES[@]}"; do
            if ! grep -q "code.*$code" "$ADMIN_FILE" && ! grep -q "code.*$code" "$USER_FILE"; then
              echo "❌ Missing error code: $code"
              exit 1
            fi
          done
          echo "✅ Stable error codes present"

  summary:
    name: AI Cost Controls Summary
    runs-on: ubuntu-latest
    needs: [validate-schema, validate-service, validate-api-endpoints]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## AI Cost Controls Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-schema.result }}" == "success" ] && \
             [ "${{ needs.validate-service.result }}" == "success" ] && \
             [ "${{ needs.validate-api-endpoints.result }}" == "success" ]; then
            echo "✅ All AI cost control validations passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Database schema validated" >> $GITHUB_STEP_SUMMARY
            echo "- AI quota service validated" >> $GITHUB_STEP_SUMMARY
            echo "- API endpoints validated" >> $GITHUB_STEP_SUMMARY
            echo "- Authentication checks present" >> $GITHUB_STEP_SUMMARY
            echo "- Stable error codes defined" >> $GITHUB_STEP_SUMMARY
            echo "- Structured logging used" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ AI cost control validations failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
