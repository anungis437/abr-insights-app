name: CSP Validation

on:
  push:
    branches: [main]
    paths:
      - 'middleware.ts'
      - 'app/layout.tsx'
      - '.github/workflows/csp-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'middleware.ts'
      - 'app/layout.tsx'

jobs:
  validate-csp-implementation:
    name: Validate CSP Implementation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check middleware.ts exists
        run: |
          if [ ! -f middleware.ts ]; then
            echo "  FAIL: middleware.ts not found"
            exit 1
          fi
          echo "[OK] PASS: middleware.ts exists"

      - name: Verify middleware.ts exports function
        run: |
          if grep -q "export async function middleware" middleware.ts; then
            echo "[OK] PASS: middleware.ts exports middleware function"
          else
            echo "  FAIL: middleware.ts missing middleware export"
            exit 1
          fi

      - name: Verify nonce generation (Web Crypto API)
        run: |
          if grep -q "crypto.getRandomValues" middleware.ts; then
            echo "[OK] PASS: Cryptographic nonce generation found"
          else
            echo "  FAIL: No cryptographic nonce generation"
            exit 1
          fi

      - name: Verify nonce is base64 encoded
        run: |
          if grep -q "btoa" middleware.ts; then
            echo "[OK] PASS: Nonce is base64 encoded"
          else
            echo "  FAIL: Nonce not base64 encoded"
            exit 1
          fi

      - name: Verify CSP header is set
        run: |
          if grep -q "Content-Security-Policy" middleware.ts; then
            echo "[OK] PASS: CSP header is set"
          else
            echo "  FAIL: CSP header not set"
            exit 1
          fi

      - name: Verify x-nonce header is set
        run: |
          if grep -q "x-nonce" middleware.ts; then
            echo "[OK] PASS: x-nonce header is set"
          else
            echo "  FAIL: x-nonce header not set"
            exit 1
          fi

      - name: Verify NO unsafe-inline in script-src
        run: |
          if grep -E "script-src.*unsafe-inline" middleware.ts; then
            echo "  FAIL: unsafe-inline found in script-src"
            exit 1
          fi
          echo "[OK] PASS: No unsafe-inline in script-src"

      - name: Verify NO unsafe-inline in style-src
        run: |
          if grep -E "style-src.*unsafe-inline" middleware.ts; then
            echo "  FAIL: unsafe-inline found in style-src"
            exit 1
          fi
          echo "[OK] PASS: No unsafe-inline in style-src"

      - name: Verify NO unsafe-eval
        run: |
          if grep -q "unsafe-eval" middleware.ts; then
            echo "  FAIL: unsafe-eval found in CSP"
            exit 1
          fi
          echo "[OK] PASS: No unsafe-eval in CSP"

      - name: Verify nonce is used in script-src
        run: |
          if grep -E "script-src.*nonce-\\\$\{nonce\}" middleware.ts; then
            echo "[OK] PASS: Nonce is used in script-src"
          else
            echo "  FAIL: Nonce not used in script-src"
            exit 1
          fi

      - name: Verify nonce is used in style-src
        run: |
          if grep -E "style-src.*nonce-\\\$\{nonce\}" middleware.ts; then
            echo "[OK] PASS: Nonce is used in style-src"
          else
            echo "  FAIL: Nonce not used in style-src"
            exit 1
          fi

      - name: Verify _dev route protection
        run: |
          if grep -q "_dev" middleware.ts && grep -q "404" middleware.ts; then
            echo "[OK] PASS: _dev route protection found"
          else
            echo "  FAIL: _dev route protection missing"
            exit 1
          fi

      - name: Verify correlation ID generation
        run: |
          if grep -q "x-correlation-id" middleware.ts; then
            echo "[OK] PASS: Correlation ID header found"
          else
            echo "[WARN]  WARN: Correlation ID header missing (non-critical)"
          fi

      - name: Check layout.tsx reads nonce
        run: |
          if [ ! -f app/layout.tsx ]; then
            echo "  FAIL: app/layout.tsx not found"
            exit 1
          fi

          if grep -q "x-nonce" app/layout.tsx; then
            echo "[OK] PASS: layout.tsx reads nonce from headers"
          else
            echo "  FAIL: layout.tsx doesn't read nonce"
            exit 1
          fi

      - name: Verify layout.tsx uses headers() function
        run: |
          if grep -q "headers()" app/layout.tsx; then
            echo "[OK] PASS: layout.tsx uses headers() function"
          else
            echo "  FAIL: layout.tsx missing headers() call"
            exit 1
          fi

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "[OK] ALL CSP IMPLEMENTATION CHECKS PASSED"
          echo "========================================"
          echo ""
          echo "Next Steps:"
          echo "1. Deploy to container"
          echo "2. Run runtime validation: ./scripts/validate-csp-runtime.sh [URL]"
          echo "3. Capture headers for documentation"
          echo ""
